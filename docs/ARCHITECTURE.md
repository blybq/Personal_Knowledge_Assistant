# 系统架构设计文档

## 概述

本文档描述了个人知识助手项目的整体系统架构设计，包括技术栈选择、组件设计、部署架构等。

## 架构设计原则

1. **模块化设计**: 各功能模块独立，便于维护和扩展
2. **前后端分离**: 前端Vue.js + 后端FastAPI，通过RESTful API通信
3. **微服务架构**: 核心服务独立部署，支持水平扩展
4. **安全性**: 完善的认证授权机制和数据加密
5. **可扩展性**: 支持功能模块的灵活扩展

## 技术栈

### 后端技术栈

- **框架**: FastAPI (Python 3.11+)
- **数据库**: MySQL 8.0+
- **ORM**: SQLAlchemy 2.0
- **向量数据库**: ChromaDB
- **对象存储**: MinIO
- **认证**: JWT (JSON Web Tokens)
- **API文档**: OpenAPI/Swagger

### 前端技术栈

- **框架**: Vue 3 + TypeScript
- **构建工具**: Vite
- **状态管理**: Pinia
- **路由**: Vue Router
- **UI组件**: 原生CSS + 自定义组件
- **HTTP客户端**: Axios

### 基础设施

- **容器化**: Docker + Docker Compose
- **反向代理**: Nginx
- **部署**: 支持本地部署和云服务器部署

## 系统架构图

```bash
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│                 │    │                 │    │                 │
│   Frontend      │◄──►│   Backend       │◄──►│   Database      │
│   (Vue 3)       │    │   (FastAPI)     │    │   (MySQL)       │
│                 │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                      │                      │
         │                      │                      │
         ▼                      ▼                      ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│                 │    │                 │    │                 │
│   Nginx         │    │   Vector DB     │    │   Object Storage│
│   (Reverse Proxy)│   │   (ChromaDB)    │    │   (MinIO)       │
│                 │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 组件设计

### 后端组件

#### 1. 认证授权模块

- 用户注册/登录
- JWT token管理
- 权限验证中间件
- 密码重置功能

#### 2. 用户管理模块

- 用户信息管理
- 用户状态管理（封禁/解封）
- 个人资料修改

#### 3. 对话管理模块

- 对话会话管理
- 消息存储和检索
- AI问答接口集成
- 流式响应处理

#### 4. 笔记管理模块

- 笔记CRUD操作
- 文件夹管理
- 文件附件管理
- 富文本编辑支持

#### 5. 组织管理模块

- 团队组织创建和管理
- 成员管理
- 邀请码系统
- 权限控制

#### 6. 管理员模块

- 系统监控
- 用户管理
- 组织管理
- 操作日志

### 前端组件

#### 1. 认证组件

- 登录/注册页面
- 密码重置流程
- Token管理

#### 2. 主界面组件

- 导航布局
- 侧边栏菜单
- 响应式设计

#### 3. 对话组件

- 聊天界面
- 消息列表
- 实时流式显示

#### 4. 笔记组件

- 笔记编辑器
- 文件树导航
- 附件管理

#### 5. 组织组件

- 组织列表
- 成员管理
- 邀请功能

## 数据流设计

### 用户登录流程

1. 用户输入邮箱密码
2. 前端发送登录请求
3. 后端验证凭据并生成JWT
4. 返回用户信息和token
5. 前端存储token并跳转到主页

### AI问答流程

1. 用户输入问题
2. 前端发送问题到后端
3. 后端调用AI模型生成回答
4. 流式返回回答内容
5. 前端实时显示回答

### 文件上传流程

1. 用户选择文件
2. 前端获取预签名URL
3. 直接上传文件到MinIO
4. 后端记录文件信息到数据库

## 部署架构

### 开发环境

```bash
前端 (Vite dev server) → 后端 (FastAPI) → 数据库 (MySQL)
```

### 生产环境

```bash
Nginx → 前端静态文件
       ↘ 后端API反向代理 → FastAPI应用 → MySQL数据库
                         ↘ ChromaDB向量数据库
                         ↘ MinIO对象存储
```

### 容器化部署

使用Docker Compose编排以下服务：

- frontend: 前端Nginx服务
- backend: 后端FastAPI应用  
- mysql: MySQL数据库
- minio: MinIO对象存储
- (可选) chroma: ChromaDB向量数据库

## 安全设计

### 认证安全

- JWT token认证
- Token过期机制
- 密码SHA256加密存储
- 防止暴力破解的登录限制

### 数据安全

- SQL注入防护
- XSS攻击防护
- CSRF保护
- 文件上传安全验证

### 网络安全

- HTTPS加密传输
- CORS配置
- 防火墙规则
- 访问日志监控

## 性能优化

### 数据库优化

- 合理的索引设计
- 查询优化
- 连接池管理
- 读写分离（可选）

## 监控和日志

### 系统监控

- 服务健康状态监控
- 性能指标监控
- 错误率监控

### 日志管理

- 访问日志
- 错误日志
- 操作审计日志
- 日志轮转和归档

## 扩展性设计

### 水平扩展

- 无状态服务设计
- 数据库读写分离
- 缓存集群支持

### 功能扩展

- 插件化架构
- Webhook支持
- 第三方集成接口

## 版本管理

### API版本控制

- URL路径版本控制（/api/v1/）
- 向后兼容性保证
- 弃用策略

### 数据库迁移

- 版本化迁移脚本
- 数据备份和恢复
- schema变更管理
